{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-center mb-4">
            <i class="fas fa-cogs me-2"></i>Company Name Verification Dashboard
        </h1>
    </div>
</div>

<!-- File Upload Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card card-hover">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Step 1: Upload Company Data</h5>
            </div>
            <div class="card-body">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h5>Upload CSV File</h5>
                    <p class="text-muted">Select a CSV file containing company names to process</p>
                    <form method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data">
                        <div class="mb-3">
                            <input type="file" class="form-control" name="file" accept=".csv" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload me-2"></i>Upload File
                        </button>
                    </form>
                </div>
                {% if progress.current_file %}
                <div class="alert alert-success mt-3">
                    <i class="fas fa-check-circle me-2"></i>Current file: <strong>{{ progress.current_file }}</strong>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Processing Steps -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card step-card card-hover">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-magic me-2"></i>Step 2: Normalize & Cluster</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Clean, normalize, and cluster company names for better matching.</p>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Progress</span>
                        <span id="normalize-progress-text">{{ progress.normalize.progress }}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar progress-animated" id="normalize-progress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <span class="badge status-badge" id="normalize-status">
                        {% if progress.normalize.status == 'idle' %}
                        <i class="fas fa-clock me-1"></i>Ready
                        {% elif progress.normalize.status == 'running' %}
                        <i class="fas fa-spinner fa-spin me-1"></i>Running
                        {% elif progress.normalize.status == 'completed' %}
                        <i class="fas fa-check me-1"></i>Completed
                        {% else %}
                        <i class="fas fa-exclamation-triangle me-1"></i>Error
                        {% endif %}
                    </span>
                </div>

                <p class="small text-muted" id="normalize-message">{{ progress.normalize.message }}</p>

                <button class="btn btn-success" id="start-normalize" {% if progress.normalize.status=='running'
                    %}disabled{% endif %}>
                    <i class="fas fa-play me-2"></i>Start Normalization
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card step-card card-hover">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-globe me-2"></i>Step 3: Website Enrichment</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Find and verify official websites for each company.</p>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Progress</span>
                        <span id="enrich-progress-text">{{ progress.enrich.progress }}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar progress-animated" id="enrich-progress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <span class="badge status-badge" id="enrich-status">
                        {% if progress.enrich.status == 'idle' %}
                        <i class="fas fa-clock me-1"></i>Ready
                        {% elif progress.enrich.status == 'running' %}
                        <i class="fas fa-spinner fa-spin me-1"></i>Running
                        {% elif progress.enrich.status == 'completed' %}
                        <i class="fas fa-check me-1"></i>Completed
                        {% else %}
                        <i class="fas fa-exclamation-triangle me-1"></i>Error
                        {% endif %}
                    </span>
                </div>

                <p class="small text-muted" id="enrich-message">{{ progress.enrich.message }}</p>

                <button class="btn btn-info" id="start-enrich" {% if progress.enrich.status=='running' %}disabled{%
                    endif %}>
                    <i class="fas fa-search me-2"></i>Start Enrichment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Processing Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card stats-card text-center">
                            <div class="card-body">
                                <i class="fas fa-file-csv fa-2x mb-2"></i>
                                <h4>{{ stats.normalized_file.rows if stats.normalized_file else 0 }}</h4>
                                <p class="mb-0">Normalized Records</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card text-center">
                            <div class="card-body">
                                <i class="fas fa-layer-group fa-2x mb-2"></i>
                                <h4>{{ stats.batch_count }}</h4>
                                <p class="mb-0">Batch Files</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card text-center">
                            <div class="card-body">
                                <i class="fas fa-building fa-2x mb-2"></i>
                                <h4>{{ stats.total_representatives }}</h4>
                                <p class="mb-0">Unique Companies</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card text-center">
                            <div class="card-body">
                                <i class="fas fa-globe fa-2x mb-2"></i>
                                <h4>{{ stats.enriched_files|length }}</h4>
                                <p class="mb-0">Enriched Files</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Download Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-download me-2"></i>Download Results</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Normalized Data</h6>
                        <p class="text-muted">Download the cleaned and normalized company data</p>
                        {% if stats.normalized_file %}
                        <a href="{{ url_for('download_file', file_type='normalized') }}"
                            class="btn btn-outline-primary">
                            <i class="fas fa-download me-2"></i>Download Normalized CSV
                        </a>
                        {% else %}
                        <button class="btn btn-outline-secondary" disabled>
                            <i class="fas fa-download me-2"></i>No data available
                        </button>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h6>Enriched Data</h6>
                        <p class="text-muted">Download the website-enriched company data</p>
                        <a href="{{ url_for('download_file', file_type='enriched') }}" class="btn {% if stats.enriched_files %}btn-outline-success{% else %}btn-outline-secondary disabled{% endif %}" id="download-enriched">
                            <i class="fas fa-download me-2"></i>{% if stats.enriched_files %}Download Enriched CSV{% else %}No data available{% endif %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Control Panel -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('reset_progress') }}" class="btn btn-warning">
            <i class="fas fa-redo me-2"></i>Reset All Progress
        </a>
    </div>
</div>
<div class="pb-3"></div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function () {
        // Auto-refresh progress every 1.5 seconds for smoother updates
        const pollIntervalMs = 1500;
        setInterval(function () {
            $.get('/progress', function (data) {
                updateProgress(data.progress);
                updateStatistics(data.stats);
            });
        }, pollIntervalMs);

        // Start normalization
        $('#start-normalize').click(function () {
            $.post('/start_normalize', function (response) {
                if (response.error) {
                    alert(response.error);
                }
            });
        });

        // Start enrichment
        $('#start-enrich').click(function () {
            $.post('/start_enrich', function (response) {
                if (response.error) {
                    alert(response.error);
                }
            });
        });

        function updateProgress(progress) {
            // Update normalization progress
            $('#normalize-progress').css('width', progress.normalize.progress + '%');
            $('#normalize-progress-text').text(progress.normalize.progress + '%');
            $('#normalize-message').text(progress.normalize.message);

            // Update enrichment progress
            $('#enrich-progress').css('width', progress.enrich.progress + '%');
            $('#enrich-progress-text').text(progress.enrich.progress + '%');
            $('#enrich-message').text(progress.enrich.message);

            // Update status badges
            updateStatusBadge('#normalize-status', progress.normalize.status);
            updateStatusBadge('#enrich-status', progress.enrich.status);

            // Update button states
            $('#start-normalize').prop('disabled', progress.normalize.status === 'running');
            $('#start-enrich').prop('disabled', progress.enrich.status === 'running');

            // When enrichment just completed, ensure downloads are enabled
            if (progress.enrich.status === 'completed') {
                // Optionally trigger a one-time refresh of stats to get latest enriched files
                $.get('/progress', function (data) {
                    updateStatistics(data.stats);
                });
            }
        }

        function updateStatusBadge(selector, status) {
            const badge = $(selector);
            badge.removeClass('bg-secondary bg-success bg-warning bg-danger');

            if (status === 'idle') {
                badge.addClass('bg-secondary').html('<i class="fas fa-clock me-1"></i>Ready');
            } else if (status === 'running') {
                badge.addClass('bg-warning').html('<i class="fas fa-spinner fa-spin me-1"></i>Running');
            } else if (status === 'completed') {
                badge.addClass('bg-success').html('<i class="fas fa-check me-1"></i>Completed');
            } else if (status === 'error') {
                badge.addClass('bg-danger').html('<i class="fas fa-exclamation-triangle me-1"></i>Error');
            }
        }

        function updateStatistics(stats) {
            // Update normalized records count
            const normalizedCount = stats.normalized_file ? stats.normalized_file.rows : 0;
            $('.stats-card').eq(0).find('h4').text(normalizedCount);

            // Update batch count
            $('.stats-card').eq(1).find('h4').text(stats.batch_count);

            // Update unique companies count
            $('.stats-card').eq(2).find('h4').text(stats.total_representatives);

            // Update enriched files count
            $('.stats-card').eq(3).find('h4').text(stats.enriched_files.length);

            // Update download buttons
            updateDownloadButtons(stats);
        }

        function updateDownloadButtons(stats) {
            // Update normalized download button
            const normalizedBtn = $('a[href*="download/normalized"]');
            if (stats.normalized_file) {
                normalizedBtn.removeClass('btn-outline-secondary').addClass('btn-outline-primary')
                    .prop('disabled', false).html('<i class="fas fa-download me-2"></i>Download Normalized CSV');
            } else {
                normalizedBtn.removeClass('btn-outline-primary').addClass('btn-outline-secondary')
                    .prop('disabled', true).html('<i class="fas fa-download me-2"></i>No data available');
            }

            // Update enriched download button
            const enrichedBtn = $('#download-enriched');
            if (stats.enriched_files.length > 0) {
                enrichedBtn.removeClass('btn-outline-secondary disabled').addClass('btn-outline-success')
                    .prop('disabled', false).html('<i class="fas fa-download me-2"></i>Download Enriched CSV');
            } else {
                enrichedBtn.removeClass('btn-outline-success').addClass('btn-outline-secondary disabled')
                    .prop('disabled', true).html('<i class="fas fa-download me-2"></i>No data available');
            }
        }
    });
</script>
{% endblock %}